# Agent Launcher - Native Platform Invocation

## Overview

The Agent Launcher module enables yanstaller to invoke specialist agents using **native platform commands** instead of generic instructions. Each platform (Copilot CLI, Claude Code, Codex) has its own command syntax and arguments.

## Architecture

```
Yanstaller
    ↓
Platform Selector (choose platform)
    ↓
Agent Launcher (native invocation)
    ↓
┌────────────────┬─────────────────┬──────────────┐
│ Copilot CLI    │ Claude Code     │ Codex        │
│ gh copilot     │ claude --agent  │ codex --agent│
│ @bmad-agent-*  │ --model --prompt│ (TBD)        │
└────────────────┴─────────────────┴──────────────┘
```

## Usage

### Interactive Launch

```javascript
const agentLauncher = require('./lib/yanstaller/agent-launcher');

// Launch agent in interactive mode (user can interact)
const result = await agentLauncher.launch({
  agent: 'claude',           // Agent name
  platform: 'claude',        // Platform ID
  prompt: 'create-mcp-server' // Initial action
});

if (result.success) {
  console.log('Agent launched successfully');
} else {
  console.error(`Launch failed: ${result.error}`);
}
```

### Non-Interactive Launch (with output)

```javascript
// Launch agent and get output (automation)
const result = await agentLauncher.launchWithPrompt({
  agent: 'claude',
  platform: 'claude',
  prompt: 'validate MCP config',
  model: 'sonnet'
});

console.log(result.output); // Agent response
```

### Get Manual Instructions

```javascript
// Get instructions for user to run manually
const instructions = agentLauncher.getLaunchInstructions({
  agent: 'marc',
  platform: 'copilot-cli',
  prompt: 'integrate agents'
});

console.log(instructions);
// Output:
// To activate the agent, run:
//   gh copilot @bmad-agent-marc integrate agents
```

## Platform-Specific Commands

### Copilot CLI

**Command**: `gh copilot`

**Arguments**:
- `@bmad-agent-{name}` - Agent invocation syntax
- `[prompt]` - Optional initial prompt

**Example**:
```bash
gh copilot @bmad-agent-marc
gh copilot @bmad-agent-byan create agent
```

**Generated by**:
```javascript
agentLauncher.launch({
  agent: 'marc',
  platform: 'copilot-cli',
  prompt: 'integrate BYAN agents'
});
// Executes: gh copilot @bmad-agent-marc integrate BYAN agents
```

### Claude Code

**Command**: `claude`

**Arguments**:
- `--agent <name>` - Agent to invoke
- `--model <model>` - Model to use (sonnet, opus, haiku)
- `--prompt <text>` - Prompt/action
- `--system-prompt <text>` - System prompt for context
- `--mcp-config <path>` - MCP server config
- `--print` - Non-interactive mode (print output and exit)

**Example Interactive**:
```bash
claude --agent claude --model sonnet create-mcp-server
```

**Example Non-Interactive**:
```bash
claude --print --agent claude --prompt "validate MCP config"
```

**Generated by**:
```javascript
agentLauncher.launch({
  agent: 'claude',
  platform: 'claude',
  prompt: 'create-mcp-server',
  model: 'sonnet'
});
// Executes: claude --agent claude --model sonnet create-mcp-server
```

### Codex (Coming Soon)

**Command**: `codex` (placeholder)

Will follow similar pattern once Codex integration is ready.

## API Reference

### `launch(options)`

Launch agent in **interactive mode** (user can interact with agent).

**Parameters**:
```typescript
interface LaunchOptions {
  agent: string;         // Agent name (e.g., 'claude', 'marc')
  platform: string;      // Platform ID (e.g., 'claude', 'copilot-cli')
  prompt?: string;       // Optional initial prompt/action
  model?: string;        // Optional model (for platforms that support it)
  config?: {
    systemPrompt?: string;
    mcpConfig?: string;
  };
}
```

**Returns**: `Promise<LaunchResult>`
```typescript
interface LaunchResult {
  success: boolean;
  method: string;        // How agent was launched
  output?: string;       // Command output (if available)
  error?: string;        // Error message if failed
}
```

**Example**:
```javascript
const result = await launch({
  agent: 'claude',
  platform: 'claude',
  prompt: 'create MCP server',
  model: 'sonnet'
});

// Result: { success: true, method: 'native-interactive' }
```

---

### `launchWithPrompt(options)`

Launch agent in **non-interactive mode** and return output. Used for automation.

**Parameters**: Same as `launch()` but `prompt` is **required**.

**Returns**: `Promise<LaunchResult>` with `output` field populated.

**Example**:
```javascript
const result = await launchWithPrompt({
  agent: 'claude',
  platform: 'claude',
  prompt: 'validate config',
  model: 'sonnet'
});

console.log(result.output); // Agent's response
```

---

### `getLaunchInstructions(options)`

Generate human-readable instructions for manual agent invocation. Used as fallback when native launch isn't available.

**Parameters**: Same as `launch()`.

**Returns**: `string` - Formatted instructions.

**Example**:
```javascript
const instructions = getLaunchInstructions({
  agent: 'claude',
  platform: 'claude',
  prompt: 'create MCP server',
  model: 'opus'
});

console.log(instructions);
// Output:
// To activate the agent, run:
//   claude --agent claude --model opus create MCP server
```

---

### `supportsNativeLaunch(platform)`

Check if platform command is available on system.

**Parameters**:
- `platform: string` - Platform ID

**Returns**: `boolean`

**Example**:
```javascript
if (supportsNativeLaunch('claude')) {
  // Launch natively
  await launch({ ... });
} else {
  // Show manual instructions
  console.log(getLaunchInstructions({ ... }));
}
```

---

### `getAvailablePlatforms()`

Get list of platforms with available commands on current system.

**Returns**: `string[]` - Array of platform IDs

**Example**:
```javascript
const platforms = getAvailablePlatforms();
// Returns: ['claude', 'copilot-cli'] (if both commands found)
```

## Integration with Yanstaller

### In Platform Installers

```javascript
// install/lib/platforms/claude-code.js

async function installViaCopilotAgent(projectRoot, agents, config) {
  const agentLauncher = require('../yanstaller/agent-launcher');
  
  // Check if native launch is available
  if (agentLauncher.supportsNativeLaunch('claude')) {
    logger.info('Launching agent Claude natively...');
    
    const result = await agentLauncher.launch({
      agent: 'claude',
      platform: 'claude',
      prompt: 'create-mcp-server'
    });
    
    if (result.success) {
      return { success: true, method: 'native' };
    }
  }
  
  // Fallback: Manual instructions
  logger.info(agentLauncher.getLaunchInstructions({
    agent: 'claude',
    platform: 'claude'
  }));
}
```

### In Wizard

```javascript
// install/lib/yanstaller/wizard.js

async function launchAgent(agentName, platform) {
  const agentLauncher = require('./agent-launcher');
  
  if (agentLauncher.supportsNativeLaunch(platform)) {
    await agentLauncher.launch({
      agent: agentName,
      platform: platform
    });
  } else {
    console.log(agentLauncher.getLaunchInstructions({
      agent: agentName,
      platform: platform
    }));
  }
}
```

## Error Handling

### Command Not Found

```javascript
const result = await launch({ agent: 'claude', platform: 'claude' });

if (result.method === 'command-not-found') {
  console.error(`${result.error}`);
  // Show manual instructions or installation guide
}
```

### Unsupported Platform

```javascript
const result = await launch({ agent: 'test', platform: 'unknown' });

if (result.method === 'unsupported') {
  console.error(`Platform not supported: ${result.error}`);
}
```

### Execution Error

```javascript
const result = await launchWithPrompt({
  agent: 'claude',
  platform: 'claude',
  prompt: 'invalid action'
});

if (!result.success) {
  console.error(`Execution failed: ${result.error}`);
}
```

## Testing

```javascript
// __tests__/yanstaller/agent-launcher.test.js

describe('agent-launcher', () => {
  it('should generate correct Claude command', () => {
    const instructions = getLaunchInstructions({
      agent: 'claude',
      platform: 'claude',
      prompt: 'test',
      model: 'sonnet'
    });
    
    expect(instructions).toContain('--agent claude');
    expect(instructions).toContain('--model sonnet');
  });
  
  it('should check command availability', () => {
    expect(supportsNativeLaunch('claude')).toBe(true);
    expect(supportsNativeLaunch('unknown')).toBe(false);
  });
});
```

## Adding New Platforms

To add support for a new platform:

1. **Add platform config** in `LAUNCH_CONFIGS`:

```javascript
const LAUNCH_CONFIGS = {
  'new-platform': {
    command: 'newcli',
    args: (agent, options = {}) => {
      const args = [];
      if (agent) args.push('--agent', agent);
      if (options.prompt) args.push(options.prompt);
      return args;
    },
    checkAvailable: () => {
      try {
        execSync('which newcli', { stdio: 'ignore' });
        return true;
      } catch {
        return false;
      }
    }
  }
};
```

2. **Test the integration**:

```javascript
it('should support new-platform', () => {
  const instructions = getLaunchInstructions({
    agent: 'test',
    platform: 'new-platform',
    prompt: 'hello'
  });
  
  expect(instructions).toContain('newcli');
});
```

3. **Update platform-selector** to include new platform.

## Future Enhancements

1. **Environment Variables**: Pass custom env vars to agents
2. **Session Management**: Track running agents and allow reconnection
3. **Parallel Execution**: Launch multiple agents simultaneously
4. **Output Streaming**: Real-time output for long-running operations
5. **Plugin System**: Allow custom launch handlers for third-party platforms

---

**Agent Launcher** enables true multi-platform native integration, making yanstaller a universal BYAN deployment tool.
