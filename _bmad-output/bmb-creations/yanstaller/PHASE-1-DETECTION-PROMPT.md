# YANSTALLER - Phase 1: Detection - Prompt Quick-Flow-Solo-Dev

**Generated by**: BYAN-TEST  
**Date**: 2026-02-03  
**Phase**: 1 - Detection  
**Duration**: 40h (jours 3-7)  
**Module**: lib/yanstaller/detector.js + utilities

---

## üéØ MISSION

Impl√©menter le module **DETECTOR** de YANSTALLER qui d√©tecte automatiquement l'environnement utilisateur :
- OS (Windows/Linux/macOS)
- Node.js version
- Git pr√©sence
- 4 plateformes (Copilot CLI, VSCode, Claude Code, Codex)

---

## üìê ARCHITECTURE CONTEXT

**Architecture**: `/home/yan/conception/_bmad-output/bmb-creations/yanstaller/ARCHITECTURE.md`  
**Score validation**: 96/100 ‚úÖ  
**Status**: Production ready

**Design patterns appliqu√©s**:
- Dependency Injection (pas de Singleton)
- Strategy pattern l√©ger (platforms)
- Custom errors (6 classes)
- Simple state object

**Mantras prioritaires**:
- #37 Ockham's Razor (simplicit√©)
- #4 Fail Fast (Node check imm√©diat)
- IA-1 Trust But Verify (validation √† chaque √©tape)
- IA-24 Clean Code (JSDoc complet)

---

## üìÇ FICHIERS √Ä IMPL√âMENTER

### 1. Utilities (Foundation)

#### `lib/utils/os-detector.js` ‚≠ê **START HERE**
**Status**: Skeleton avec JSDoc  
**Complexity**: LOW  
**Time**: 2h  

**Functions √† impl√©menter**:
```javascript
detect() ‚Üí {name, version, platform}
isWindows() ‚Üí boolean
isMacOS() ‚Üí boolean
isLinux() ‚Üí boolean
```

**Tests requis**:
- `__tests__/utils/os-detector.test.js`
- 4 tests (detect, isWindows, isMacOS, isLinux)
- Mock `os.platform()` et `os.release()`

---

#### `lib/utils/node-detector.js`
**Status**: Skeleton avec JSDoc  
**Complexity**: LOW  
**Time**: 3h  

**Functions √† impl√©menter**:
```javascript
detect() ‚Üí string (e.g., '18.19.0')
compareVersions(v1, v2) ‚Üí -1 | 0 | 1
meetsRequirement(current, required) ‚Üí boolean
```

**‚ö†Ô∏è ATTENTION**: G√©rer versions avec suffixes (`18.0.0-beta`)

**Tests requis**:
- `__tests__/utils/node-detector.test.js`
- 6 tests minimum
  - detect() retourne version string
  - compareVersions() cas: √©gal, sup√©rieur, inf√©rieur
  - meetsRequirement() cas: OK, trop vieux, suffixes

**Recommandation**: Utiliser regex pour strip suffixes avant comparaison

---

#### `lib/utils/git-detector.js`
**Status**: Skeleton avec JSDoc  
**Complexity**: LOW  
**Time**: 2h  

**Function √† impl√©menter**:
```javascript
detect() ‚Üí Promise<{installed: boolean, version: string | null}>
```

**Technique**: `execSync('git --version')` avec try/catch

**Tests requis**:
- `__tests__/utils/git-detector.test.js`
- 2 tests
  - Git install√© ‚Üí {installed: true, version: '2.x.x'}
  - Git absent ‚Üí {installed: false, version: null}
- Mock `execSync`

---

### 2. Platform Detectors

#### `lib/platforms/copilot-cli.js`
**Status**: Partial skeleton  
**Complexity**: MEDIUM  
**Time**: 5h  

**Function √† impl√©menter**:
```javascript
detect() ‚Üí Promise<boolean>
```

**Logique**:
1. Check command `github-copilot-cli` existe
2. OU check directory `.github/agents/` existe

**Tests requis**:
- `__tests__/platforms/copilot-cli.test.js`
- 3 tests
  - CLI install√© ‚Üí true
  - Seulement .github/agents/ ‚Üí true
  - Rien ‚Üí false

---

#### `lib/platforms/vscode.js`
**Status**: Minimal skeleton (reuse copilot)  
**Complexity**: LOW  
**Time**: 2h  

**Note**: R√©utilise `copilot-cli.detect()` (m√™me format)

**Tests requis**:
- `__tests__/platforms/vscode.test.js`
- 1 test (appelle copilot-cli.detect())

---

#### `lib/platforms/claude-code.js`
**Status**: Partial skeleton  
**Complexity**: MEDIUM  
**Time**: 4h  

**Function √† impl√©menter**:
```javascript
detect() ‚Üí Promise<boolean>
```

**Logique**:
- Check config file existe selon OS:
  - macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
  - Windows: `~/AppData/Roaming/Claude/claude_desktop_config.json`
  - Linux: `~/.config/Claude/claude_desktop_config.json`

**Tests requis**:
- `__tests__/platforms/claude-code.test.js`
- 3 tests (un par OS)
- Mock `fs.pathExists()`

---

#### `lib/platforms/codex.js`
**Status**: Partial skeleton  
**Complexity**: LOW  
**Time**: 2h  

**Function √† impl√©menter**:
```javascript
detect() ‚Üí Promise<boolean>
```

**Logique**: Check `.codex/prompts/` directory exists

**Tests requis**:
- `__tests__/platforms/codex.test.js`
- 2 tests (exists / not exists)

---

### 3. Main Detector Module

#### `lib/yanstaller/detector.js` ‚≠ê **CRITICAL**
**Status**: Skeleton avec TODOs  
**Complexity**: HIGH  
**Time**: 10h  

**Functions √† impl√©menter**:
```javascript
detect() ‚Üí Promise<DetectionResult>
isNodeVersionValid(current, required) ‚Üí boolean
detectPlatform(platformName) ‚Üí Promise<PlatformInfo>
```

**Logique `detect()`**:
```javascript
async function detect() {
  // Parallel detection for speed
  const [osInfo, nodeVersion, gitInfo, platformsInfo] = await Promise.all([
    osDetector.detect(),
    nodeDetector.detect(),
    gitDetector.detect(),
    detectAllPlatforms()
  ]);
  
  return {
    os: osInfo.name,
    osVersion: osInfo.version,
    nodeVersion,
    hasGit: gitInfo.installed,
    gitVersion: gitInfo.version,
    platforms: platformsInfo
  };
}

async function detectAllPlatforms() {
  const platformNames = ['copilot-cli', 'vscode', 'claude', 'codex'];
  const results = await Promise.all(
    platformNames.map(name => detectPlatform(name))
  );
  return results;
}
```

**‚ö†Ô∏è AM√âLIORATION**: Ajouter timeout 10s par platform (recommandation BYAN-TEST)

**Tests requis**:
- `__tests__/yanstaller/detector.test.js`
- 10 tests minimum
  - detect() retourne structure compl√®te
  - detect() parallel (Promise.all)
  - isNodeVersionValid() cas edge
  - detectPlatform() pour chaque platform
  - Timeout platform detection (si impl√©ment√©)

---

## üìä ACCEPTANCE CRITERIA (Phase 1)

### Must Pass (Bloquants):
- [ ] AC-YAN-DET-01: Detect OS correctement (Win/Linux/macOS)
- [ ] AC-YAN-DET-02: Detect Node.js version (‚â•18.0.0 required)
- [ ] AC-YAN-DET-03: Detect Git presence (warning only si absent)
- [ ] AC-YAN-DET-04: Detect 4 platforms (Copilot CLI, VSCode, Claude, Codex)
- [ ] AC-YAN-DET-05: Generate detection report complet

### Quality (Non-bloquants mais fortement recommand√©s):
- [ ] Tests coverage > 80%
- [ ] JSDoc √† jour (si modifs)
- [ ] Multi-OS tests pass (CI/CD)
- [ ] Pas d'emojis dans code (Mantra IA-23)
- [ ] Code self-documenting (Mantra IA-24)

---

## üß™ TDD APPROACH (MANDATORY)

**M√©thodologie**:
1. **√âcrire tests AVANT code** (TDD strict)
2. Tests unitaires d'abord (utilities)
3. Tests d'int√©gration ensuite (detector.js)
4. Run tests apr√®s chaque fonction
5. Refactor si n√©cessaire

**Ordre recommand√©**:
```
1. os-detector.test.js + os-detector.js
2. node-detector.test.js + node-detector.js
3. git-detector.test.js + git-detector.js
4. copilot-cli.test.js + copilot-cli.detect()
5. vscode.test.js + vscode.detect()
6. claude-code.test.js + claude-code.detect()
7. codex.test.js + codex.detect()
8. detector.test.js + detector.js (orchestration)
```

---

## üö¶ TESTS CI/CD

**Commandes**:
```bash
# Run tests
cd install
npm test

# Run tests avec coverage
npm test -- --coverage

# Run linter
npm run lint

# Fix linter auto
npm run lint:fix
```

**CI/CD d√©clenchement**:
- Push sur branch ‚Üí GitHub Actions run automatiquement
- Matrix: 3 OS √ó 3 Node versions = 9 combinaisons
- Coverage upload vers Codecov (Ubuntu + Node 20 seulement)

---

## üîß DEPENDENCIES DISPONIBLES

**D√©j√† install√©es** (voir package.json):
- `inquirer` (CLI prompts) - pas n√©cessaire Phase 1
- `fs-extra` (file ops) - **OUI** pour fileUtils
- `chalk` (colors) - **OUI** pour logger
- `ora` (spinners) - pas n√©cessaire Phase 1
- `js-yaml` (YAML) - pas n√©cessaire Phase 1
- `commander` (CLI args) - pas n√©cessaire Phase 1

**DevDependencies**:
- `jest` - **OUI** pour tests
- `eslint` - **OUI** pour linting
- `prettier` - **OUI** pour formatting

**‚ö†Ô∏è SI BESOIN NOUVELLE DEP**: Justifier dans issue/PR

---

## üìù CONTRAINTES TECHNIQUES

### Multi-OS
**CRITIQUE**: Code doit fonctionner sur 3 OS

**Bonnes pratiques**:
```javascript
// ‚úÖ BON
const agentPath = path.join(projectRoot, '_bmad', 'agents');

// ‚ùå MAUVAIS
const agentPath = projectRoot + '/_bmad/agents'; // Fail sur Windows
```

### Error Handling
**Utiliser custom errors** (d√©j√† cr√©√©es dans `lib/errors.js`):
```javascript
const { NodeVersionError, PlatformNotFoundError } = require('../errors');

if (nodeVersion < '18.0.0') {
  throw new NodeVersionError('18.0.0', nodeVersion);
}
```

### Exit Codes
**Utiliser exit-codes.js** (nouvellement cr√©√©):
```javascript
const exitCodes = require('../exit-codes');

if (detectFailed) {
  process.exit(exitCodes.PLATFORM_ERROR);
}
```

---

## üéØ MANTRAS √Ä RESPECTER

### #37 - Ockham's Razor
**Application**: Code simple > code clever
- Pas de one-liners complexes
- Fonctions courtes (< 30 lignes)
- Nommage explicite

### #4 - Fail Fast
**Application**: Erreurs d√©tect√©es imm√©diatement
- Node version check en premier
- Throw errors rapidement
- Pas de silent failures

### IA-1 - Trust But Verify
**Application**: Valider chaque d√©tection
- Tests pour chaque function
- Edge cases couverts
- Multi-OS validation (CI)

### IA-24 - Clean Code
**Application**: Code self-documenting
- JSDoc complet si nouvelles functions
- Nommage clair (pas de `x`, `tmp`, `data`)
- Minimal comments (only WHY, not WHAT)

### IA-23 - No Emoji Pollution
**Application**: Zero emojis dans code
- ‚ùå Pas d'emojis dans JSDoc
- ‚ùå Pas d'emojis dans strings code
- ‚úÖ Emojis OK dans CLI output (logger)

---

## üêõ DEBUG TIPS

### Si tests √©chouent:
```bash
# Run un seul test file
npm test -- detector.test.js

# Run avec verbose
npm test -- --verbose

# Run avec watch mode
npm test -- --watch
```

### Si linter √©choue:
```bash
# Voir erreurs
npm run lint

# Auto-fix
npm run lint:fix
```

### Si CI √©choue:
1. Check logs GitHub Actions (`.github/workflows/yanstaller-test.yml`)
2. Reproduire localement m√™me OS/Node version
3. Check multi-OS issues (path separator, permissions)

---

## üìö RESSOURCES DISPONIBLES

**Architecture compl√®te**:
- `_bmad-output/bmb-creations/yanstaller/ARCHITECTURE.md` (27 KB)
- `_bmad-output/bmb-creations/yanstaller/ARCHITECTURE-SUMMARY.md` (13 KB)

**Plan d√©veloppement**:
- `_bmad-output/bmb-creations/yanstaller/PLAN-DEVELOPPEMENT.md` (29 KB)

**Risques & mitigation**:
- `_bmad-output/bmb-creations/yanstaller/RISKS.md` (8.3 KB)

**Specs agent**:
- `_bmad-output/bmb-creations/yanstaller/AgentSpec-yanstaller.yaml` (9.7 KB)

**Code skeleton**:
- `install/lib/yanstaller/detector.js` (JSDoc + TODOs)
- `install/lib/utils/*.js` (7 utilities)
- `install/lib/platforms/*.js` (4 platforms + index)

---

## üéä DEFINITION OF DONE (Phase 1)

**Consid√©r√© termin√© quand**:
- [x] Tous les AC-YAN-DET-01 √† 05 passent
- [x] Tests coverage ‚â• 80% (detector + utilities + platforms)
- [x] CI/CD passe sur 3 OS (GitHub Actions green)
- [x] Linter passe (0 errors)
- [x] Code review OK (BYAN-TEST validation)
- [x] Documentation √† jour (JSDoc si modifs)
- [x] Zero emojis dans code (Mantra IA-23)
- [x] Commit messages clean (pas d'emojis)

---

## üöÄ COMMENCER MAINTENANT

**Premi√®re action**:
```bash
cd /home/yan/conception/install

# Cr√©er branch
git checkout -b phase-1-detection

# Cr√©er premier test
touch __tests__/utils/os-detector.test.js
```

**Premier test √† √©crire** (TDD):
```javascript
// __tests__/utils/os-detector.test.js
const osDetector = require('../../lib/utils/os-detector');

describe('osDetector', () => {
  describe('detect()', () => {
    it('should return OS information', () => {
      const result = osDetector.detect();
      
      expect(result).toHaveProperty('name');
      expect(result).toHaveProperty('version');
      expect(result).toHaveProperty('platform');
      
      expect(['windows', 'linux', 'macos']).toContain(result.name);
    });
  });
});
```

**Run test** (doit FAIL d'abord - TDD):
```bash
npm test -- os-detector.test.js
```

**Puis impl√©menter** `lib/utils/os-detector.js` pour faire passer test.

---

## üí° CONSEILS QUICK-FLOW-SOLO-DEV

1. **TDD strict**: Tests avant code (toujours)
2. **Commits fr√©quents**: Apr√®s chaque function qui passe tests
3. **Push souvent**: CI d√©tecte probl√®mes multi-OS t√¥t
4. **Consulte architecture**: Si doute sur design
5. **Challenge d√©cisions**: Si quelque chose semble over-engineered
6. **Code simple**: Mantra #37 Ockham's Razor
7. **JSDoc √† jour**: Si tu ajoutes functions

---

## üìû SUPPORT

**Si besoin aide**:
- Architecture: Relis ARCHITECTURE.md
- Mantras: `@byan-test MAN` (Display 64 Mantras)
- Challenge design: Ping BYAN-TEST ou Winston
- Bugs multi-OS: Check CI logs ‚Üí reproduire localement

---

**BON COURAGE ! 40h de dev, mais architecture solide = guidage clair.** üöÄ

**TDD from Day 1. Tests before code. Always.** ‚úÖ
