/**
 * Generate project-agents.md from Phase 2 analysis results
 * Creates a structured document describing the agent ecosystem for the project
 */

const fs = require('fs-extra');
const path = require('path');

/**
 * Generate the project-agents.md file
 * @param {Object} phase2Results - JSON from yanstaller-phase2 agent
 * @param {Object} genericAnswers - Q1-Q10 answers
 * @param {Object} domainAnswers - Domain-specific answers
 * @param {string} outputDir - Directory to write the file
 * @returns {string} Path to generated file
 */
async function generateProjectAgentsDoc(phase2Results, genericAnswers, domainAnswers, outputDir) {
  const lines = [];
  
  // Header
  lines.push('# Project Agents Configuration');
  lines.push('');
  lines.push('> Generated by BYAN Yanstaller - Intelligent Interview');
  lines.push(`> Date: ${new Date().toISOString().split('T')[0]}`);
  lines.push('');
  
  // Project Overview
  lines.push('## Project Overview');
  lines.push('');
  lines.push(`- **Type**: ${genericAnswers.projectType}`);
  lines.push(`- **Domain**: ${genericAnswers.domain}`);
  lines.push(`- **Team Size**: ${genericAnswers.teamSize}`);
  lines.push(`- **Methodology**: ${genericAnswers.methodology}`);
  lines.push(`- **Quality Level**: ${genericAnswers.quality}`);
  lines.push('');
  
  // Domain Details
  if (Object.keys(domainAnswers).length > 0) {
    lines.push('### Tech Stack');
    lines.push('');
    for (const [key, value] of Object.entries(domainAnswers)) {
      lines.push(`- **${formatKey(key)}**: ${value}`);
    }
    lines.push('');
  }
  
  // Core Agents
  if (phase2Results.coreAgents && phase2Results.coreAgents.length > 0) {
    lines.push('## Core Agents');
    lines.push('');
    lines.push('These agents are essential for your project workflow.');
    lines.push('');
    
    for (const agent of phase2Results.coreAgents) {
      lines.push(`### ${formatAgentName(agent.name)}`);
      lines.push('');
      lines.push(`**Role**: ${agent.role}`);
      lines.push('');
      lines.push(`**Expertise**: ${agent.expertise.join(', ')}`);
      lines.push('');
      lines.push(`**Complexity**: ${getComplexityBadge(agent.complexity)}`);
      lines.push('');
    }
  }
  
  // Optional Agents
  if (phase2Results.optionalAgents && phase2Results.optionalAgents.length > 0) {
    lines.push('## Optional Agents');
    lines.push('');
    lines.push('Activate these agents when specific conditions are met.');
    lines.push('');
    
    for (const agent of phase2Results.optionalAgents) {
      lines.push(`### ${formatAgentName(agent.name)}`);
      lines.push('');
      lines.push(`**Role**: ${agent.role}`);
      lines.push('');
      lines.push(`**When to use**: ${agent.when || 'As needed'}`);
      lines.push('');
    }
  }
  
  // Agent Relationships
  if (phase2Results.agentRelationships && phase2Results.agentRelationships.length > 0) {
    lines.push('## Agent Relationships');
    lines.push('');
    lines.push('```mermaid');
    lines.push('graph LR');
    
    for (const rel of phase2Results.agentRelationships) {
      const arrow = getRelationshipArrow(rel.type);
      lines.push(`    ${rel.from}${arrow}${rel.to}`);
    }
    
    lines.push('```');
    lines.push('');
    lines.push('### Relationship Details');
    lines.push('');
    lines.push('| From | To | Type | Description |');
    lines.push('|------|-----|------|-------------|');
    
    for (const rel of phase2Results.agentRelationships) {
      lines.push(`| ${rel.from} | ${rel.to} | ${rel.type} | ${rel.description || '-'} |`);
    }
    lines.push('');
  }
  
  // Project Structure
  if (phase2Results.projectStructure) {
    lines.push('## Project Structure');
    lines.push('');
    lines.push(`**Architecture**: ${phase2Results.projectStructure.type}`);
    lines.push('');
    
    if (phase2Results.projectStructure.folders) {
      lines.push('### Recommended Folders');
      lines.push('');
      lines.push('```');
      for (const folder of phase2Results.projectStructure.folders) {
        lines.push(folder);
      }
      lines.push('```');
      lines.push('');
    }
    
    if (phase2Results.projectStructure.keyFiles) {
      lines.push('### Key Files');
      lines.push('');
      for (const file of phase2Results.projectStructure.keyFiles) {
        lines.push(`- \`${file}\``);
      }
      lines.push('');
    }
  }
  
  // Custom Agents to Create
  if (phase2Results.customAgentsToCreate && phase2Results.customAgentsToCreate.length > 0) {
    lines.push('## Custom Agents to Create');
    lines.push('');
    lines.push('These specialized agents will be generated for your project.');
    lines.push('');
    
    for (const agent of phase2Results.customAgentsToCreate) {
      lines.push(`### ${formatAgentName(agent.name)}`);
      lines.push('');
      lines.push(`**Based on**: ${agent.template} template`);
      lines.push('');
      lines.push(`**Focus**: ${agent.focus}`);
      lines.push('');
      if (agent.mantras && agent.mantras.length > 0) {
        lines.push('**Key Mantras**:');
        for (const mantra of agent.mantras) {
          lines.push(`- ${mantra}`);
        }
        lines.push('');
      }
    }
  }
  
  // Configuration
  lines.push('## Configuration');
  lines.push('');
  lines.push(`**Recommended Model**: \`${phase2Results.recommendedModel || 'gpt-5-mini'}\``);
  lines.push('');
  if (phase2Results.rationale) {
    lines.push('### Rationale');
    lines.push('');
    lines.push(phase2Results.rationale);
    lines.push('');
  }
  
  // Usage Instructions
  lines.push('## Usage');
  lines.push('');
  lines.push('### Activate Core Agents');
  lines.push('');
  lines.push('```bash');
  lines.push('copilot');
  lines.push('# Then type: /agent');
  lines.push('# Select the agent you need');
  lines.push('```');
  lines.push('');
  lines.push('### Create Custom Agents');
  lines.push('');
  lines.push('```bash');
  lines.push('copilot --agent=byan');
  lines.push('# Select: 1. Create New Agent');
  lines.push('# Follow the interview process');
  lines.push('```');
  lines.push('');
  
  // Write file
  const content = lines.join('\n');
  const filePath = path.join(outputDir, 'project-agents.md');
  await fs.ensureDir(outputDir);
  await fs.writeFile(filePath, content, 'utf8');
  
  return filePath;
}

// Helper functions

function formatKey(key) {
  return key
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .trim();
}

function formatAgentName(name) {
  return name
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

function getComplexityBadge(complexity) {
  switch (complexity) {
    case 'simple': return 'ðŸŸ¢ Simple (1-2 mantras)';
    case 'medium': return 'ðŸŸ¡ Medium (3-5 mantras)';
    case 'complex': return 'ðŸ”´ Complex (6+ mantras)';
    default: return 'âšª Unknown';
  }
}

function getRelationshipArrow(type) {
  switch (type) {
    case 'triggers': return ' -->|triggers| ';
    case 'blocks': return ' -.->|blocks| ';
    case 'informs': return ' -->|informs| ';
    case 'depends': return ' ==>|depends| ';
    default: return ' --> ';
  }
}

module.exports = {
  generateProjectAgentsDoc
};
